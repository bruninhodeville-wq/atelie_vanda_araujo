{% extends "base.html" %}

{% block title %}Novo Pedido{% endblock %}

{% block content %}
<div class="container-form">
    
    <a href="/home" class="voltar"><i class='bx bx-arrow-back'></i> Cancelar e Voltar</a>

    <h1>
        {% if pedido_atual %}
            Editar Pedido <span style="color: var(--magenta-neon);">#{{ proximo_id }}</span>
        {% else %}
            Novo Pedido <span style="color: var(--magenta-neon);">#{{ proximo_id }}</span>
        {% endif %}
    </h1>

    <form action="/pedidos/novo" method="POST" onsubmit="return prepararEnvio()">
        <input type="hidden" name="pedido_id_editar" value="{{ pedido_atual.id if pedido_atual else '' }}">

        <div class="form-section-title">
            <i class='bx bx-user-circle'></i> 1. Identificar Cliente
        </div>
        
        <div class="row">
            <div class="col" style="flex: 3;">
                <label>Buscar Cliente:</label>
                <input list="clientes_list" id="busca_cliente" placeholder="Digite o nome para buscar..." 
                       value="{{ pedido_atual.cliente.nome if pedido_atual else '' }}" autocomplete="off">
                <datalist id="clientes_list">
                    {% for cliente in clientes %}
                        <option data-id="{{ cliente.id }}" data-telefone="{{ cliente.telefone }}" data-tipo="{{ cliente.tipo_cliente }}" value="{{ cliente.nome }}">
                    {% endfor %}
                </datalist>
                <input type="hidden" name="cliente_id" id="cliente_id_hidden" value="{{ pedido_atual.cliente_id if pedido_atual else '' }}">
            </div>
            <div class="col">
                 <a href="/clientes/novo" style="color: var(--magenta-neon); font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 20px; text-align: right;">+ Cadastrar Novo</a>
            </div>
        </div>

        <div id="info_cliente" style="background: #fdf2ff; padding: 15px; border-radius: 15px; border: 1px dashed var(--magenta-neon); display: none; margin-bottom: 20px; color: #555;">
            <strong>Cliente Selecionado:</strong> <span id="span_nome">---</span> <br>
            <strong>Tabela Padrão:</strong> <span id="span_tipo">---</span>
        </div>

        <div class="form-section-title">
            <i class='bx bx-shopping-bag'></i> 2. Adicionar Produtos
        </div>

        <div style="background: #fafafa; padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #eee;">
            
            <div class="row" style="margin-bottom: 15px;">
                <div class="col">
                    <label style="color: var(--roxo-profundo); font-weight: bold;">Tabela de Preço para este item:</label>
                    <select id="tabela_preco_select" style="border-color: var(--magenta-neon);">
                        <option value="Varejo">Varejo</option>
                        <option value="Atacado">Atacado</option>
                        <option value="Atacarejo">Atacarejo</option>
                        <option value="Atacado Premium">Atacado Premium</option>
                    </select>
                </div>
                <div class="col" style="flex: 2;"></div> 
            </div>

            <div class="row">
                <div class="col" style="flex: 2;">
                    <label>Produto:</label>
                    <select id="produto_select">
                        <option value="">-- Escolha --</option>
                        {% for p in produtos %}
                            <option value="{{ p.id }}" 
                                    data-varejo="{{ p.preco_varejo }}" 
                                    data-atacado="{{ p.preco_atacado }}"
                                    data-atacarejo="{{ p.preco_atacarejo }}"
                                    data-premium="{{ p.preco_atacado_premium }}">
                                {{ p.nome_produto }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col">
                    <label>Cor:</label>
                    <input type="text" id="cor_input" placeholder="Ex: Vermelho">
                </div>
                <div class="col" style="max-width: 100px;">
                    <label>Qtd:</label>
                    <input type="number" id="qty_input" value="1" min="1">
                </div>
                <div class="col" style="max-width: 150px;">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-add" onclick="adicionarAoCarrinho()" style="width: 100%;">
                        <i class='bx bx-plus'></i> Incluir
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="tabela_carrinho">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Cor</th>
                        <th>Tabela</th>
                        <th>Preço Unit.</th>
                        <th>Qtd</th>
                        <th>Subtotal</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div style="text-align: right; margin-top: 15px; font-size: 1.2rem; color: var(--roxo-profundo);">
            Total Estimado: <strong id="total_display">R$ 0.00</strong>
        </div>

        <input type="hidden" name="itens_carrinho" id="itens_carrinho_json">

        <div class="form-section-title">
            <i class='bx bx-truck'></i> 3. Detalhes do Envio
        </div>

        <label>Forma de Envio:</label>
        <select name="forma_envio">
            <option value="Retirada" {% if pedido_atual and pedido_atual.forma_envio == 'Retirada' %}selected{% endif %}>Retirada no Ateliê</option>
            <option value="Correios" {% if pedido_atual and pedido_atual.forma_envio == 'Correios' %}selected{% endif %}>Correios (PAC/Sedex)</option>
            <option value="Motoboy" {% if pedido_atual and pedido_atual.forma_envio == 'Motoboy' %}selected{% endif %}>Motoboy</option>
            <option value="Excursão" {% if pedido_atual and pedido_atual.forma_envio == 'Excursão' %}selected{% endif %}>Excursão</option>
        </select>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

        <button type="submit" class="btn-gradiente">
            <i class='bx bx-check-circle'></i> Gerar Pedido
        </button>
    </form>
</div>

<script>
    let carrinho = [];
    
    // Recupera dados se for edição
    const dadosEdicao = JSON.parse('{{ itens_pre_carregados | safe }}');
    if(dadosEdicao.length > 0) {
        carrinho = dadosEdicao;
        renderizarCarrinho();
    }

    // 1. Identificar Cliente e selecionar Tabela Automaticamente
    const buscaInput = document.getElementById('busca_cliente');
    const hiddenId = document.getElementById('cliente_id_hidden');
    const infoDiv = document.getElementById('info_cliente');
    const tabelaSelect = document.getElementById('tabela_preco_select'); // Novo Select
    
    buscaInput.addEventListener('input', function() {
        const val = this.value;
        const opts = document.getElementById('clientes_list').options;
        for (let i = 0; i < opts.length; i++) {
            if (opts[i].value === val) {
                hiddenId.value = opts[i].getAttribute('data-id');
                const tipo = opts[i].getAttribute('data-tipo');
                
                // Atualiza visual
                document.getElementById('span_nome').innerText = val;
                document.getElementById('span_tipo').innerText = tipo;
                infoDiv.style.display = 'block';
                
                // ATUALIZA O SELECT DE PREÇO AUTOMATICAMENTE
                // Tenta selecionar a opção que bate com o tipo do cliente
                // Se não existir (ex: erro de cadastro), mantém o que estava ou Varejo
                for(let j=0; j < tabelaSelect.options.length; j++){
                    if(tabelaSelect.options[j].value === tipo){
                        tabelaSelect.selectedIndex = j;
                        break;
                    }
                }
                return;
            }
        }
        hiddenId.value = "";
        infoDiv.style.display = 'none';
    });
    
    if(buscaInput.value) { buscaInput.dispatchEvent(new Event('input')); }

    // 2. Adicionar ao Carrinho usando a Tabela Selecionada
    function adicionarAoCarrinho() {
        const sel = document.getElementById('produto_select');
        const opt = sel.options[sel.selectedIndex];
        
        if(!opt.value) { alert("Escolha um produto"); return; }
        
        // Pega a tabela que o usuário escolheu no momento
        const tabelaEscolhida = document.getElementById('tabela_preco_select').value;
        
        let preco = 0;
        
        // Pega o preço correspondente dos dados do produto
        if(tabelaEscolhida === 'Atacado') {
            preco = parseFloat(opt.getAttribute('data-atacado'));
        } else if(tabelaEscolhida === 'Atacarejo') {
            preco = parseFloat(opt.getAttribute('data-atacarejo'));
        } else if(tabelaEscolhida === 'Atacado Premium') {
            preco = parseFloat(opt.getAttribute('data-premium'));
        } else {
            // Padrão Varejo
            preco = parseFloat(opt.getAttribute('data-varejo'));
        }

        // Validação de segurança caso preço venha zerado ou NaN
        if(isNaN(preco)) preco = 0;

        const item = {
            id: opt.value,
            nome: opt.text.trim(),
            cor: document.getElementById('cor_input').value,
            qty: parseInt(document.getElementById('qty_input').value),
            tabela: tabelaEscolhida, // Salvamos qual tabela foi usada
            preco: preco,
            subtotal: preco * parseInt(document.getElementById('qty_input').value)
        };
        
        carrinho.push(item);
        renderizarCarrinho();
        
        // Limpa campos menores
        document.getElementById('cor_input').value = "";
        document.getElementById('qty_input').value = "1";
    }

    function removerItem(index) {
        carrinho.splice(index, 1);
        renderizarCarrinho();
    }

    function renderizarCarrinho() {
        const tbody = document.querySelector('#tabela_carrinho tbody');
        tbody.innerHTML = "";
        let total = 0;
        
        carrinho.forEach((item, index) => {
            total += item.subtotal;
            // Adicionei a coluna Tabela para visualização
            const tr = `
                <tr>
                    <td>${item.nome}</td>
                    <td>${item.cor}</td>
                    <td><span style="font-size:0.85rem; background:#f0f0f0; padding:2px 6px; border-radius:4px;">${item.tabela || 'Padrão'}</span></td>
                    <td>R$ ${item.preco.toFixed(2)}</td>
                    <td>${item.qty}</td>
                    <td>R$ ${item.subtotal.toFixed(2)}</td>
                    <td><button type="button" onclick="removerItem(${index})" style="color:red; background:none; border:none; cursor:pointer;"><i class='bx bx-trash'></i></button></td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
        
        document.getElementById('total_display').innerText = "R$ " + total.toFixed(2);
        document.getElementById('itens_carrinho_json').value = JSON.stringify(carrinho);
    }

    function prepararEnvio() {
        if (!document.getElementById('cliente_id_hidden').value) {
            alert("Selecione um cliente válido da lista!");
            return false;
        }
        if (carrinho.length === 0) {
            alert("Adicione pelo menos um produto!");
            return false;
        }
        return true;
    }
</script>
{% endblock %}